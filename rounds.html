<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round Status Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .status-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: #4caf50;
            border-radius: 10px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #4caf50;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>CoinJoin Round Status</h1>
    
    <div class="status-card">
        <div class="header">
            <h2>Current Round</h2>
            <button id="refresh-btn">Refresh</button>
        </div>
        <div id="round-info">Loading...</div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://coinjoin.kruw.io/wabisabi/human-monitor';
        
        // Function to fetch data - trying multiple CORS proxies
        async function fetchRoundData() {
            const refreshBtn = document.getElementById('refresh-btn');
            const roundInfo = document.getElementById('round-info');
            
            // Show loading state
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = 'Refreshing <span class="loading"></span>';
            
            // List of CORS proxies to try in order
            const proxies = [
                (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];
            
            let success = false;
            let error = null;
            
            // Try each proxy in order until one works
            for (const proxyFn of proxies) {
                if (success) break;
                
                try {
                    const proxyUrl = proxyFn(API_URL);
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        cache: 'no-store', // Force fetch to bypass cache
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    let data;
                    // Different proxies return data in different formats
                    if (proxyUrl.includes('allorigins')) {
                        const result = await response.json();
                        data = JSON.parse(result.contents);
                    } else {
                        // Direct JSON for other proxies
                        data = await response.json();
                    }
                    
                    displayRoundData(data);
                    success = true;
                } catch (e) {
                    console.error('Error with proxy:', e);
                    error = e;
                    // Continue to next proxy
                }
            }
            
            // Reset button state
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = 'Refresh';
            
            // If all proxies failed
            if (!success) {
                console.error('All proxies failed:', error);
                roundInfo.innerHTML = 
                    `<p style="color: red">Error loading data. Please try again later.</p>
                     <p>Last error: ${error.message}</p>`;
            }
        }
        
        // Function to display the round data
        function displayRoundData(data) {
            if (!data || !data.roundStates || data.roundStates.length === 0) {
                document.getElementById('round-info').innerHTML = 
                    '<p>No active rounds at the moment.</p>';
                return;
            }
            
            const round = data.roundStates[0]; // Get the first round
            
            let progressPercentage = 0;
            if (round.inputCount > 0) {
                // Calculate how full the round is based on current vs max input count
                progressPercentage = Math.min(100, (round.inputCount / 50) * 100);
            }
            
            let html = `
                <p><strong>Round ID:</strong> ${round.roundId.substring(0, 8)}...${round.roundId.substring(round.roundId.length - 8)}</p>
                <p><strong>Phase:</strong> ${round.phase}</p>
                <p><strong>Input Count:</strong> ${round.inputCount}</p>
                <p><strong>Max Suggested Amount:</strong> ${round.maxSuggestedAmount}</p>
                ${round.isBlameRound ? '<p><strong>Blame Round</strong></p>' : ''}
                ${round.inputRegistrationRemaining ? `<p><strong>Time Remaining:</strong> ${round.inputRegistrationRemaining}</p>` : ''}
                
                <p><strong>Progress:</strong></p>
                <div class="progress-bar">
                    <div class="progress" style="width: ${progressPercentage}%"></div>
                </div>
                <p>Last updated: ${new Date().toLocaleTimeString()}</p>
            `;
            
            document.getElementById('round-info').innerHTML = html;
        }
        
        // Alternative method using jsonp-like approach with script tags
        // This is a fallback if all CORS proxies fail
        function fetchWithScriptTag() {
            // Remove any previous script tag
            const oldScript = document.getElementById('jsonp-script');
            if (oldScript) {
                document.body.removeChild(oldScript);
            }
            
            // Create a unique callback name
            const callbackName = 'jsonpCallback_' + Math.random().toString(36).substring(2, 15);
            
            // Add the callback to window
            window[callbackName] = function(data) {
                displayRoundData(data);
                // Clean up
                delete window[callbackName];
                document.body.removeChild(document.getElementById('jsonp-script'));
            };
            
            // Create a new script tag
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = `${API_URL}?callback=${callbackName}&_=${Date.now()}`; // Add timestamp to prevent caching
            
            // Handle errors
            script.onerror = function() {
                document.getElementById('round-info').innerHTML = 
                    '<p style="color: red">Error loading data. Please try again later.</p>';
                delete window[callbackName];
                document.body.removeChild(script);
            };
            
            // Add to document
            document.body.appendChild(script);
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            fetchRoundData().catch(error => {
                console.error('Initial load failed:', error);
                // Try the alternative method if the first method fails
                fetchWithScriptTag();
            });
            
            // Set up refresh button
            document.getElementById('refresh-btn').addEventListener('click', function() {
                fetchRoundData().catch(error => {
                    console.error('Refresh failed:', error);
                    fetchWithScriptTag();
                });
            });
        });
        
        // Optional: Auto-refresh every 60 seconds
        setInterval(function() {
            fetchRoundData().catch(error => {
                console.error('Auto-refresh failed:', error);
                // No fallback for auto-refresh to avoid excessive script creation
            });
        }, 60000);
    </script>
</body>
</html>
